<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>{{ sneaker.model }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
    <script type="module">
        import QrScanner from "https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.min.js";
        QrScanner.WORKER_PATH = 'https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner-worker.min.js';

        const shoeId = "{{ sneaker._id }}";
        let qrScanner;

        const videoElem = document.createElement('video');
        videoElem.style.width = '100%';
        videoElem.style.height = '100%';
        document.getElementById('qr-reader').appendChild(videoElem);

        const scannedTagInput = document.getElementById("scanned-tag");
        const tagList = document.getElementById("tag-list");
        const addTagBtn = document.getElementById("add-tag");
        const qrModal = document.getElementById("qrModal");

        function formatMac(raw) {
            return raw.toUpperCase().match(/.{1,2}/g).join(":");
        }

        function loadTags() {
            fetch(`/sneaker/${shoeId}/tags`)
                .then(res => res.json())
                .then(tags => {
                tagList.innerHTML = "";
                tags.forEach(tag => {
                    const li = document.createElement("li");
                    li.className = "list-group-item d-flex justify-content-between align-items-center";
                    li.innerHTML = `
                        ${tag.tagAddress}
                        <button class="btn btn-sm btn-danger" onclick="deleteTag('${tag._id}')">Excluir</button>
                    `;
                    tagList.appendChild(li);
                });
            });
        }

        window.deleteTag = function (tagId) {
            fetch(`/tag/${tagId}`, { method: "DELETE" })
                .then(() => loadTags());
        }

        addTagBtn.addEventListener("click", () => {
            const tagAddress = scannedTagInput.value.trim();
            if (!tagAddress) return;

            fetch(`/sneaker/${shoeId}/tags`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ tagAddress })
            })
                .then(() => {
                scannedTagInput.value = "";
                loadTags();
            });
        });

        qrModal.addEventListener('shown.bs.modal', () => {
            qrScanner = new QrScanner(videoElem, result => {
                const mac = formatMac(result);
                scannedTagInput.value = mac;

                qrScanner.stop();
                const modalInstance = bootstrap.Modal.getInstance(qrModal);
                modalInstance.hide();
            });

            qrScanner.start().catch(e => {
                console.error("Erro ao iniciar scanner:", e);
            });
        });

        qrModal.addEventListener('hidden.bs.modal', () => {
            if (qrScanner) qrScanner.stop();
        });

        // Carregar tags ao abrir a página
        loadTags();
    </script>


    <style>
        .sneaker-title {
            font-weight: bold;
            font-size: 2rem;
        }
        .sneaker-description {
            font-size: 1.1rem;
            color: #555;
        }
        .image-gallery img,
        .color-variation img,
        .suggestion img {
            max-height: 200px;
            object-fit: cover;
        }
        input[type="text"], textarea {
            width: 100%;
            margin-top: 4px;
        }
        label {
            font-weight: 500;
            margin-top: 10px;
        }
        .select2-container--default .select2-selection--single {
            height: 40px;
        }
        .select2-results__option img {
            height: 30px;
            margin-right: 8px;
        }
    </style>
</head>
<body class="bg-light">

<div class="container my-5">
    <!-- Título e Modelo -->
    <div class="text-center mb-4">
        <label for="modelInput">Modelo do Sneaker</label>
        <input id="modelInput" type="text" class="form-control text-center sneaker-title mb-2"
               value="{{ sneaker.model }}">

        <label for="titleInput">Título</label>
        <input id="titleInput" type="text" class="form-control text-center text-muted" value="{{ sneaker.title }}">
    </div>

    <!-- Descrição -->
    <div class="mb-5">
        <label for="descriptionInput">Descrição</label>
        <textarea id="descriptionInput" class="form-control sneaker-description"
                  rows="4">{{ sneaker.description }}</textarea>
    </div>

    <!-- Galeria de Imagens -->
    <div class="mb-5">
        <h4>Imagens</h4>
        <div id="image-gallery" class="row image-gallery align-items-end">
            {% for img in sneaker.images %}
            <div class="col-6 col-md-4 mb-4">
                <img id="gallery-img-{{ loop.index }}" src="{{ img }}" class="img-fluid rounded shadow-sm mb-2"
                     alt="Imagem do sneaker">
                <label>URL da Imagem</label>
                <input type="text" class="form-control" value="{{ img }}"
                       data-img-target="gallery-img-{{ loop.index }}">
                <button class="btn btn-sm btn-danger remove-item mt-2">Excluir</button>

            </div>
            {% endfor %}
        </div>
        {% if sneaker.images|length < 3 %}
        <button id="add-image" class="btn btn-outline-primary">Adicionar Imagem</button>
        {% endif %}
    </div>

    <!-- Variações de Cor -->
    <div class="mb-5">
        <h4>Variações de cor</h4>
        <div id="color-variation" class="row color-variation align-items-end">
            {% for color in sneaker.colors %}
            <div class="col-6 col-md-4 text-center mb-4">
                <img id="color-img-{{ loop.index }}" src="{{ color.image }}" class="img-fluid rounded border mb-2"
                     alt="Cor">
                <input type="text" class="form-control mb-2" value="{{ color.image }}"
                       data-img-target="color-img-{{ loop.index }}">

                <label>Modelo da Cor</label>
                <input type="text" class="form-control mb-1" value="{{ color.model }}">

                <label>Código da Cor</label>
                <input type="text" class="form-control mb-2" value="{{ color.code }}">

                 <input type="hidden" class="shoe-id-hidden" value="{{ color.shoeId }}">

                <label>Selecionar Tênis</label>
                <select class="form-select sneaker-dropdown" data-img-id="color-img-{{ loop.index }}">
                    <option value="">-- Selecione um tênis --</option>
                </select>
                <button class="btn btn-sm btn-danger remove-item mt-2">Excluir</button>
            </div>
            {% endfor %}
        </div>
        {% if sneaker.colors|length < 3 %}
        <button id="add-color" class="btn btn-outline-primary">Adicionar variação de cor</button>
        {% endif %}
    </div>

    <!-- Sugestões -->
    <div class="mb-5">
        <h4>Você também pode gostar</h4>
        <div id="suggestion-section" class="row suggestion align-items-end">
            {% for s in sneaker.suggestion %}
            <div class="col-6 col-md-4 text-center mb-4">
                <img id="suggestion-img-{{ loop.index }}" src="{{ s.image }}" class="img-fluid rounded border mb-2"
                     alt="Sugestão">
                <input type="text" class="form-control mb-2" value="{{ s.image }}"
                       data-img-target="suggestion-img-{{ loop.index }}">

                <label>Modelo Sugerido</label>
                <input type="text" class="form-control mb-1" value="{{ s.model }}">

                <label>Código do Sugerido</label>
                <input type="text" class="form-control mb-2" value="{{ s.code }}">

                <input type="hidden" class="shoe-id-hidden" value="{{ s.shoeId }}">

                <label>Selecionar Tênis</label>
                <select class="form-select sneaker-dropdown" data-img-id="suggestion-img-{{ loop.index }}">
                    <option value="">-- Selecione um tênis --</option>
                </select>
                <button class="btn btn-sm btn-danger remove-item mt-2">Excluir</button>
            </div>
            {% endfor %}
        </div>
        {% if sneaker.suggestion|length < 3 %}
        <button id="add-suggestion" class="btn btn-outline-primary">Adicionar sugestão</button>
        {% endif %}
    </div>

    <div class="text-center mb-5">
        <button onclick="printSneakerObject()" class="btn btn-success">Imprimir Objeto Atual</button>
    </div>


    <!-- Gerenciar Tags -->
    <div class="mb-5">
        <h4>Tags associadas</h4>
        <ul id="tag-list" class="list-group mb-3"></ul>

        <div class="mb-3">
            <label for="scanned-tag">Endereço de Tag (lido por QR)</label>
            <input type="text" id="scanned-tag" class="form-control mb-2" placeholder="xx:xx:xx:xx:xx:xx">
            <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#qrModal">Escanear QR Code</button>
            <button id="add-tag" class="btn btn-primary">Adicionar</button>
        </div>
    </div>

    <!-- Modal de QR Code -->
    <div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="qrModalLabel">Escanear QR Code da Tag</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div id="qr-reader" style="width: 100%; height: 400px; background: #000;"></div>
                </div>
            </div>
        </div>
    </div>


</div>

<!-- JS Libraries -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    document.getElementById("add-image")?.addEventListener("click", function () {
        const container = document.getElementById("image-gallery");
        const count = container.children.length + 1;

        const col = document.createElement("div");
        col.className = "col-6 col-md-4 mb-4";
        col.innerHTML = `
            <img id="gallery-img-${count}" src="" class="img-fluid rounded shadow-sm mb-2" alt="Imagem do sneaker">
            <input type="text" class="form-control" data-img-target="gallery-img-${count}">
            <button class="btn btn-sm btn-danger remove-item mt-2">Excluir</button>
        `;
        container.appendChild(col);

        col.querySelector("input").addEventListener("input", function () {
            const img = document.getElementById(this.getAttribute("data-img-target"));
            if (img) img.src = this.value;
        });

        if (container.children.length >= 3) {
            this.style.display='none';
        }
    });
</script>

<script>
    document.getElementById("add-color")?.addEventListener("click", function () {
        const container = document.getElementById("color-variation");
        const count = container.children.length + 1;

        const col = document.createElement("div");
        col.className = "col-6 col-md-4 text-center mb-4";
        col.innerHTML = `
            <img id="color-img-${count}" src="" class="img-fluid rounded border mb-2" alt="Cor">
            <input type="text" class="form-control mb-2" data-img-target="color-img-${count}">

            <label>Modelo da Cor</label>
            <input type="text" class="form-control mb-1" value="">

            <label>Código da Cor</label>
            <input type="text" class="form-control mb-2" value="">

            <input type="hidden" class="shoe-id-hidden" value="">

            <label>Selecionar Tênis</label>
            <select class="form-select sneaker-dropdown" data-img-id="color-img-${count}">
                <option value="">-- Selecione um tênis --</option>
            </select>
            <button class="btn btn-sm btn-danger remove-item mt-2">Excluir</button>
        `;
        container.appendChild(col);

        // Permitir atualização da imagem ao digitar
        col.querySelector('input[data-img-target]').addEventListener('input', function () {
            const img = document.getElementById(this.getAttribute('data-img-target'));
            if (img) img.src = this.value;
        });

        // Recarregar dropdown
        populateDropdowns();

        if (container.children.length >= 3) {
            this.style.display='none';
        }
    });
</script>

<script>
    document.getElementById("add-suggestion")?.addEventListener("click", function () {
        const container = document.getElementById("suggestion-section");
        const count = container.children.length + 1;

        const col = document.createElement("div");
        col.className = "col-6 col-md-4 text-center mb-4";
        col.innerHTML = `
            <img id="suggestion-img-${count}" src="" class="img-fluid rounded border mb-2" alt="Sugestão">
            <input type="text" class="form-control mb-2" data-img-target="suggestion-img-${count}">

            <label>Modelo Sugerido</label>
            <input type="text" class="form-control mb-1" value="">

            <label>Código do Sugerido</label>
            <input type="text" class="form-control mb-2" value="">

            <input type="hidden" class="shoe-id-hidden" value="">

            <label>Selecionar Tênis</label>
            <select class="form-select sneaker-dropdown" data-img-id="suggestion-img-${count}">
                <option value="">-- Selecione um tênis --</option>
            </select>
            <button class="btn btn-sm btn-danger remove-item mt-2">Excluir</button>
        `;
        container.appendChild(col);

        col.querySelector('input[data-img-target]').addEventListener('input', function () {
            const img = document.getElementById(this.getAttribute('data-img-target'));
            if (img) img.src = this.value;
        });

        populateDropdowns();

        if (container.children.length >= 3) {
            this.style.display='none';
        }
    });
</script>


<script>
    // Atualiza imagem ao digitar no campo de URL
    document.querySelectorAll('input[data-img-target]').forEach(input => {
        input.addEventListener('input', function () {
            const targetId = this.getAttribute('data-img-target');
            const img = document.getElementById(targetId);
            if (img) {
                img.src = this.value;
            }
        });
    });

    let sneakersData = [];

    // Buscar dados do endpoint
    fetch('/shoes-with-images')
        .then(res => res.json())
        .then(data => {
        sneakersData = data;
        populateDropdowns();
    });

    // Preencher todos os dropdowns com Select2 e imagens
    function populateDropdowns() {
        document.querySelectorAll('.sneaker-dropdown').forEach(select => {
            // Evitar duplicar opções
            if (select.options.length <= 1) {
                sneakersData.forEach((s, i) => {
                    if (!s.images || !s.images[1]) return;

                    const option = document.createElement('option');
                    option.value = i;
                    option.text = `${s.code} - ${s.model}`;
                    option.setAttribute('data-image', s.images[1]);
                    select.appendChild(option);
                });
            }

            $(select).select2({
                templateResult: formatSneaker,
                templateSelection: formatSneaker,
                width: '100%'
            });

            $(select).on('select2:select', function (e) {
                const index = e.params.data.id;
                const selected = sneakersData[index];
                const parent = this.closest('.col-6');

                const imgId = this.getAttribute('data-img-id');
                const imgEl = document.getElementById(imgId);
                const imgInput = parent.querySelector('input[data-img-target]');
                const modelInput = parent.querySelector('input:nth-of-type(2)');
                const codeInput = parent.querySelector('input:nth-of-type(3)');
                const shoeIdInput = parent.querySelector('.shoe-id-hidden');

                if (imgEl) imgEl.src = selected.images[1];
                if (imgInput) imgInput.value = selected.images[1];
                if (modelInput) modelInput.value = selected.model;
                if (codeInput) codeInput.value = selected.code;
                if (shoeIdInput) shoeIdInput.value = selected._id.$oid;
            });
        });
    }

    // Função para mostrar imagem + texto no dropdown
    function formatSneaker(s) {
        if (!s.id) return s.text;
        const img = $(s.element).data('image');
        if (!img) return s.text;
        return $(`<span><img src="${img}" style="height: 30px; margin-right: 8px;"> ${s.text}</span>`);
    }


    function enableItemRemoval(sectionId, addButtonId) {
        const container = document.getElementById(sectionId);
        container.addEventListener('click', function (e) {
            if (e.target.classList.contains('remove-item')) {
                e.target.closest('.col-6').remove();

                // Mostrar botão se tiver menos de 3 itens
                if (container.children.length < 3) {
                    document.getElementById(addButtonId).style.display = 'inline-block';
                }
            }
        });
    }

    // Ativar exclusão para todas as seções
    enableItemRemoval("image-gallery", "add-image");
    enableItemRemoval("color-variation", "add-color");
    enableItemRemoval("suggestion-section", "add-suggestion");

</script>

<script>
    function printSneakerObject() {
        const sneaker = {
            _id: "{{ sneaker._id }}",
            code: "{{ sneaker.code }}",
            model: document.getElementById("modelInput").value.trim(),
            title: document.getElementById("titleInput").value.trim(),
            description: document.getElementById("descriptionInput").value.trim(),
            images: [],
            colors: [],
            suggestion: []
        };

        // Imagens principais
        document.querySelectorAll('#image-gallery input[data-img-target]').forEach(input => {
            const url = input.value.trim();
            if (url) sneaker.images.push(url);
        });

        // Variações de cor
        document.querySelectorAll('#color-variation .col-6').forEach(col => {
            const image = col.querySelector('input[data-img-target]').value.trim();
            const model = col.querySelector('input:nth-of-type(2)').value.trim();
            const code = col.querySelector('input:nth-of-type(3)').value.trim();
            const shoeId = col.querySelector('.shoe-id-hidden')?.value.trim();

            if (image && model && code) {
                sneaker.colors.push({ image, model, code, shoeId });
            }
        });

        // Sugestões
        document.querySelectorAll('#suggestion-section .col-6').forEach(col => {
            const image = col.querySelector('input[data-img-target]').value.trim();
            const model = col.querySelector('input:nth-of-type(2)').value.trim();
            const code = col.querySelector('input:nth-of-type(3)').value.trim();
            const shoeId = col.querySelector('.shoe-id-hidden')?.value.trim();

            if (image && model && code) {
                sneaker.suggestion.push({ image, model, code, shoeId });
            }
        });

        console.log("Sneaker atualizado:", sneaker);
        alert("Objeto sneaker atualizado foi impresso no console.");
    }

</script>

</body>
</html>
